<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Mario 99</title>
    <link rel="stylesheet" href="./styles/style.css">
    <link rel="modulepreload" href="./scripts/script.js">
    <link rel="modulepreload" href="./scripts/Game.js">
    <link rel="modulepreload" href="./scripts/Board.js">
    <link rel="modulepreload" href="./scripts/Shape.js">
    <link rel="modulepreload" href="./scripts/components.js">
    <link rel="modulepreload" href="./scripts/spriteCache.js">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
            min-height: 100vh;
            font-family: 'Press Start 2P', cursive;
            overflow-x: hidden;
            position: relative;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Animated background particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #00ffff;
            border-radius: 50%;
            animation: float 6s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        .main-container {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 0px;
        }

        .logo-container {
            margin-bottom: 5px;
            animation: logoGlow 2s ease-in-out infinite alternate;
        }

        @keyframes logoGlow {
            from { filter: drop-shadow(0 0 20px #00ffff); }
            to { filter: drop-shadow(0 0 40px #ff00ff); }
        }

        .logo {
            width: 500px;
            height: 250px;
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .title {
            color: #00ffff;
            font-size: 3rem;
            text-align: center;
            margin-top: 0;
            margin-bottom: 10px;
            text-shadow: 0 0 20px #00ffff;
            animation: titlePulse 2s ease-in-out infinite;
        }

        @keyframes titlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .subtitle {
            color: #ff00ff;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 50px;
            text-shadow: 0 0 10px #ff00ff;
            animation: subtitleFlicker 3s ease-in-out infinite;
        }

        @keyframes subtitleFlicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .instructions {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .instruction-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid #00ffff;
            min-width: 120px;
        }

        .key {
            background: #333;
            color: #00ffff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
            text-shadow: 0 0 5px #00ffff;
            border: 1px solid #00ffff;
        }

        .action {
            color: #fff;
            font-size: 0.7rem;
            text-align: center;
        }

        .menu-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            margin-bottom: 30px;
        }

        .menu-button {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.2rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: 3px solid #fff;
            border-radius: 15px;
            padding: 20px 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            min-width: 300px;
            text-align: center;
        }

        .menu-button .emoji {
            font-size: 30px;
            display: inline-block;
            margin-right: 15px;
            vertical-align: middle;
        }

        .menu-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .menu-button:hover::before {
            left: 100%;
        }

        .menu-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 255, 255, 0.5);
            background: linear-gradient(45deg, #ff8e8e, #6eddd6);
        }

        .menu-button:active {
            transform: translateY(-2px);
        }

        .primary-button {
            font-size: 1.5rem;
            padding: 25px 50px;
            min-width: 400px;
            background: linear-gradient(45deg, #ff00ff, #00ffff);
        }

        .secondary-button {
            font-size: 1rem;
            padding: 15px 30px;
            min-width: 250px;
            background: linear-gradient(45deg, #4ecdc4, #45b7aa);
        }

        .room-section {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .room-section {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
        }

        #roomCodeDisplay {
            font-size: 1.5rem;
            color: #00ffff;
            text-align: center;
            margin: 20px 0;
            text-shadow: 0 0 10px #00ffff;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00ffff;
        }

        .room-code-container {
            text-align: center;
            font-size: 2rem;
            color: #ff00ff;
            text-shadow: 0 0 20px #ff00ff;
            background: rgba(0, 0, 0, 0.7);
            padding: 30px;
            border-radius: 15px;
            border: 3px solid #ff00ff;
            margin: 20px 0;
            animation: roomCodeGlow 2s ease-in-out infinite alternate;
        }

        .room-code-container.error {
            color: #ff4444;
            text-shadow: 0 0 20px #ff4444;
            border-color: #ff4444;
            animation: errorPulse 1s ease-in-out infinite alternate;
        }

        @keyframes roomCodeGlow {
            from { box-shadow: 0 0 20px rgba(255, 0, 255, 0.5); }
            to { box-shadow: 0 0 40px rgba(255, 0, 255, 0.8); }
        }

        @keyframes errorPulse {
            from { box-shadow: 0 0 20px rgba(255, 68, 68, 0.5); }
            to { box-shadow: 0 0 40px rgba(255, 68, 68, 0.8); }
        }

        .game-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00ffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Rules overlay */
        .rules-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .rules-overlay:not(.hidden) {
            display: flex !important;
        }
        .rules-modal {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border: 4px solid #00ffff;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.4);
        }
        .rules-title {
            color: #00ffff;
            font-size: 2.8rem;
            margin-bottom: 24px;
            text-align: center;
            text-shadow: 0 0 10px #00ffff;
        }
        .rules-list {
            color: #fff;
            font-size: 2em;
            line-height: 4;
            margin: 0 0 24px 0;
            padding-left: 1.5em;
        }
        .rules-list li {
            margin-bottom: 1em;
        }
        .rules-emoji {
            font-size: 1.8em;
            line-height: 1;
            vertical-align: -0.15em;
        }
        .rules-close-btn {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: 3px solid #fff;
            border-radius: 12px;
            padding: 15px 30px;
            cursor: pointer;
            display: block;
            margin: 0 auto;
            transition: all 0.2s ease;
        }
        .rules-close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.4);
        }

        /* AI Mode button: hidden by default, shown on logo click or Ctrl+Shift / Cmd+Shift */
        .ai-mode-shortcut {
            display: none !important;
        }
        .ai-mode-shortcut.visible {
            display: flex !important;
        }

        .game-container {
            position: relative;
            margin: 20px auto 0;
            z-index: 10;
        }

        .game-container:not(.hidden) {
            display: block;
        }

        /* Wrapper for game boards - side-by-side on desktop in AI mode, stacked on mobile */
        .ai-boards-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px auto 0;
            width: fit-content;
            max-width: none;
        }
        @media (min-width: 769px) {
            body.ai-mode .ai-boards-row {
                flex-direction: row;
                justify-content: center;
                align-items: flex-start;
                flex-wrap: nowrap;
            }
            /* In AI mode on desktop, boards use normal flow for side-by-side layout */
            body.ai-mode .game-container {
                position: relative !important;
                top: auto !important;
                left: auto !important;
                transform: none !important;
                margin: 0 !important;
            }
        }
        /* Mobile AI mode: fix and center the stacked boards (same graceful zoom/lock as single canvas) */
        @media (max-width: 768px) {
            body.ai-mode {
                overflow: hidden;
            }
            body.ai-mode .ai-boards-row {
                position: fixed !important;
                top: calc(50% + 30px) !important;
                left: 50% !important;
                margin: 0 !important;
                z-index: 10;
                transform: translate(-50%, -50%);
            }
            @supports (height: 100dvh) {
                body.ai-mode .ai-boards-row {
                    top: calc(50dvh + 30px) !important;
                }
            }
            body.ai-mode .touch-controls {
                bottom: 5px !important;
            }
            body.ai-mode .game-container {
                position: relative !important;
                top: auto !important;
                left: auto !important;
                transform: none !important;
                margin: 0 !important;
            }
        }

        /* Touch Controls */
        .touch-controls {
            position: fixed;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
        }

        /* Show touch controls only on mobile */
        @media (max-width: 768px) {
            .touch-controls {
                display: flex;
            }
        }

        .control-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border: 3px solid #00ffff;
            border-radius: 15px;
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            color: #00ffff;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .control-btn:hover {
            background: linear-gradient(145deg, #2a2a4e, #26214e);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.5);
        }

        .control-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 255, 255, 0.3);
            background: linear-gradient(145deg, #0a0a1e, #06113e);
        }

        .move-btn {
            border-color: #00ff00;
            color: #00ff00;
            box-shadow: 0 4px 15px rgba(0, 255, 0, 0.3);
        }

        .move-btn:hover {
            box-shadow: 0 6px 20px rgba(0, 255, 0, 0.5);
        }

        .rotate-btn {
            border-color: #ff00ff;
            color: #ff00ff;
            box-shadow: 0 4px 15px rgba(255, 0, 255, 0.3);
        }

        .rotate-btn:hover {
            box-shadow: 0 6px 20px rgba(255, 0, 255, 0.5);
        }

        .control-icon {
            width: 24px;
            height: 24px;
            display: block;
            stroke: currentColor;
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        #rotateLeft .rotate-left-icon {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 1;
            transform: rotate(0deg);
        }

        #rotateRight .rotate-right-icon {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 1;
            transform: rotate(0deg);
        }

        .drop-btn {
            border-color: #ff4444;
            color: #ff4444;
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
        }

        .drop-btn:hover {
            box-shadow: 0 6px 20px rgba(255, 68, 68, 0.5);
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .game-container {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                margin: 0;
            }
            @supports (height: 100dvh) {
                .game-container {
                    top: 50dvh;
                }
            }
            .touch-controls {
                flex-direction: column;
                gap: 10px;
            }
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            .control-icon {
                width: 20px;
                height: 20px;
            }
            #rotateLeft .rotate-left-icon,
            #rotateRight .rotate-right-icon {
                width: 26px;
                height: 26px;
            }
            
            .control-row {
                gap: 10px;
            }
            .control-row.drop-row {
                width: 100%;
                justify-content: center;
            }
            #dropFast {
                width: calc((50px * 4) + (10px * 3));
                max-width: calc(100vw - 24px);
            }
        }

        /* Custom Alert Modal */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-in-out;
        }

        .alert-modal {
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border: 3px solid #00ffff;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            animation: slideIn 0.4s ease-out;
            position: relative;
            overflow: hidden;
        }

        .alert-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(0, 255, 255, 0.1) 50%, transparent 70%);
            animation: shimmer 2s infinite;
        }

        .alert-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 0 10px currentColor;
            position: relative;
            z-index: 1;
        }

        .alert-title.win {
            color: #00ff00;
            animation: winPulse 1s ease-in-out infinite alternate;
        }

        .alert-title.lose {
            color: #ff4444;
            animation: losePulse 1s ease-in-out infinite alternate;
        }

        .alert-message {
            font-size: 1.2rem;
            color: #ffffff;
            margin-bottom: 25px;
            line-height: 1.4;
            position: relative;
            z-index: 1;
        }

        .alert-button {
            background: linear-gradient(145deg, #00ffff, #0099cc);
            border: 2px solid #00ffff;
            border-radius: 8px;
            color: #000;
            font-size: 1.1rem;
            font-weight: bold;
            padding: 12px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);
        }

        .alert-button:hover {
            background: linear-gradient(145deg, #00cccc, #0077aa);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.5);
        }

        .alert-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 255, 255, 0.3);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-50px) scale(0.8);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes winPulse {
            from { 
                color: #00ff00;
                text-shadow: 0 0 10px #00ff00;
            }
            to { 
                color: #88ff88;
                text-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00;
            }
        }

        @keyframes losePulse {
            from { 
                color: #ff4444;
                text-shadow: 0 0 10px #ff4444;
            }
            to { 
                color: #ff8888;
                text-shadow: 0 0 20px #ff4444, 0 0 30px #ff4444;
            }
        }

        @keyframes victoryGlow {
            from { 
                opacity: 0;
                transform: scale(0.5) rotate(10deg);
            }
            to { 
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        @keyframes victoryPulse {
            from { 
                color: #00ff00;
                text-shadow: 0 0 20px #00ff00, 0 0 40px #00ff00;
            }
            to { 
                color: #88ff88;
                text-shadow: 0 0 30px #00ff00, 0 0 60px #00ff00, 0 0 80px #00ff00;
            }
        }

        @keyframes defeatGlow {
            from { 
                opacity: 0;
                transform: scale(0.5) rotate(-10deg);
            }
            to { 
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        @keyframes defeatPulse {
            from { 
                color: #ff4444;
                text-shadow: 0 0 20px #ff4444, 0 0 40px #ff4444;
            }
            to { 
                color: #ff8888;
                text-shadow: 0 0 30px #ff4444, 0 0 60px #ff4444, 0 0 80px #ff4444;
            }
        }

        /* Retro scanlines effect */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 255, 255, 0.03) 2px,
                rgba(0, 255, 255, 0.03) 4px
            );
            pointer-events: none;
            z-index: 5;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .logo {
                width: 350px;
                height: 175px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .instructions {
                gap: 15px;
                margin-bottom: 30px;
            }
            
            .instruction-item {
                min-width: 100px;
                padding: 10px 15px;
            }
            
            .key {
                font-size: 0.7rem;
                padding: 4px 8px;
            }
            
            .action {
                font-size: 0.6rem;
            }
            
            .menu-button {
                min-width: 250px;
                font-size: 1rem;
                padding: 15px 30px;
            }
            
            .primary-button {
                font-size: 1.2rem;
                min-width: 300px;
            }
            
            .rules-modal {
                padding: 24px;
            }
            .rules-title {
                font-size: 1.4rem;
            }
            .rules-list {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    <div class="scanlines"></div>
    
    <div class="main-container">
        <div class="logo-container">
            <img src="img/logo.png" alt="Dr. Mario 99" class="logo" id="logoClick" title="Click to reveal AI Mode">
        </div>
        
    
        
        
        <div id="playbuttons" class="menu-container">
            <button id="freePlay" class="menu-button primary-button">
                <span class="emoji">üéÆ</span>FREE PLAY
            </button>
            <button id="single" class="menu-button primary-button">
                <span class="emoji">üë§</span>SINGLE PLAYER
            </button>
            <button id="aiMode" class="menu-button primary-button ai-mode-shortcut" aria-hidden="true">
                <span class="emoji">ü§ñ</span>AI MODE
            </button>
            
            <div class="room-section">
                <button id="createRoom" class="menu-button secondary-button">
                    <span class="emoji">üè†</span>CREATE ROOM
                </button>
                <button id="joinRoom" class="menu-button secondary-button">
                    <span class="emoji">üö™</span>JOIN ROOM
                </button><br>
                <button id="rulesBtn" class="menu-button secondary-button">
                    <span class="emoji">üìú</span>RULES
                </button>
            </div>
        </div>

        <!-- Rules overlay (hidden by default) -->
        <div id="rulesOverlay" class="rules-overlay hidden">
            <div class="rules-modal">
                <h2 class="rules-title">How to Play</h2>
                <ol class="rules-list">
                    <li><span class="rules-emoji">üéÆ</span> Press <strong>Free Play</strong> to be matched with a random player.</li>
                    <li><span class="rules-emoji">ü§ù</span> Or create a room to battle your friends.</li>
                    <li><span class="rules-emoji">ü¶†</span> Every time your opponent kills a germ, it sends a germ your way!</li>
                    <li><span class="rules-emoji">üèÜ</span> The person who gets rid of all their germs first wins!</li>
                </ol>
                <button id="rulesClose" class="rules-close-btn">Got it! </button>
            </div>
        </div>

        <div id="roomCodeContainer" class="room-code-container hidden">
            <h1><p id="roomCodeDisplay"></p></h1>
        </div>

        <div class="ai-boards-row">
            <div class="game-container hidden" id="game1">
                <div id="top-player1"></div>
                <div id="score-player1"></div>
                <div id="virusCount-player1"></div>
            </div>

            <div class="game-container hidden" id="game2">
                <div id="top-player2"></div>
                <div id="score-player2"></div>
                <div id="virusCount-player2"></div>
            </div>
        </div>

        <!-- Touch Controls -->
        <div class="touch-controls hidden" id="touchControls">
            <div class="control-row top-row">
                <button class="control-btn move-btn" id="moveLeft" aria-label="Move left">
                    <svg viewBox="0 0 24 24" class="control-icon" aria-hidden="true">
                        <line x1="20" y1="12" x2="4" y2="12"></line>
                        <polyline points="10 6 4 12 10 18"></polyline>
                    </svg>
                </button>
                <button class="control-btn rotate-btn" id="rotateLeft" aria-label="Rotate left">
                    <svg viewBox="0 0 24 24" class="control-icon rotate-left-icon" aria-hidden="true">
                        <path d="M7 8a7 7 0 1 1-1 8"></path>
                        <polyline points="12 8 7 8 7 3"></polyline>
                    </svg>
                </button>
                <button class="control-btn rotate-btn" id="rotateRight" aria-label="Rotate right">
                    <svg viewBox="0 0 24 24" class="control-icon rotate-right-icon" aria-hidden="true">
                        <path d="M17 8a7 7 0 1 0 1 8"></path>
                        <polyline points="12 8 17 8 17 3"></polyline>
                    </svg>
                </button>
                <button class="control-btn move-btn" id="moveRight" aria-label="Move right">
                    <svg viewBox="0 0 24 24" class="control-icon" aria-hidden="true">
                        <line x1="4" y1="12" x2="20" y2="12"></line>
                        <polyline points="14 6 20 12 14 18"></polyline>
                    </svg>
                </button>
            </div>
            <div class="control-row drop-row">
                <button class="control-btn drop-btn" id="dropFast" aria-label="Drop fast">
                    <svg viewBox="0 0 24 24" class="control-icon" aria-hidden="true">
                        <line x1="12" y1="4" x2="12" y2="20"></line>
                        <polyline points="6 14 12 20 18 14"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
        <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
        <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
        <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
    </div>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script type="module">
        import { preloadGameplaySprites } from './scripts/spriteCache.js';
        preloadGameplaySprites();
    </script>
    <script>
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const socket = io(window.location.origin);

        let player = 0; // Default player number
        let who = 0;
        let roomCode = ''; // Variable to store the room code

        // Create animated particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Initialize particles on page load
        document.addEventListener('DOMContentLoaded', createParticles);

        // Enhanced button click effects
        function addButtonEffects() {
            const buttons = document.querySelectorAll('.menu-button');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    // Add click animation
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });
            });
        }

        // Initialize button effects
        document.addEventListener('DOMContentLoaded', addButtonEffects);

        // Enhanced room code display
        function showRoomCode(message, isError = false) {
            const roomCodeContainer = document.getElementById('roomCodeContainer');
            const roomCodeDisplay = document.getElementById('roomCodeDisplay');
            
            roomCodeDisplay.textContent = message;
            roomCodeContainer.className = isError ? 'room-code-container error' : 'room-code-container';
            roomCodeContainer.classList.remove('hidden');
        }

        function hideRoomCode() {
            document.getElementById('roomCodeContainer').classList.add('hidden');
        }

        // Scale gameplay UI down when viewport is narrower than the fixed 960px game canvas.
        const GAME_CANVAS_WIDTH = 960;
        const GAME_CANVAS_HEIGHT = 720; // approximate height of one game container (board + throwing + header)
        function isGameVisible() {
            const game1Visible = !document.getElementById('game1').classList.contains('hidden');
            const game2Visible = !document.getElementById('game2').classList.contains('hidden');
            return game1Visible || game2Visible;
        }
        function getActiveGameContainer() {
            const game1 = document.getElementById('game1');
            const game2 = document.getElementById('game2');
            if (game1 && !game1.classList.contains('hidden')) return game1;
            if (game2 && !game2.classList.contains('hidden')) return game2;
            return null;
        }
        function getVisibleGameContainers() {
            const containers = [];
            const game1 = document.getElementById('game1');
            const game2 = document.getElementById('game2');
            if (game1 && !game1.classList.contains('hidden')) containers.push(game1);
            if (game2 && !game2.classList.contains('hidden')) containers.push(game2);
            return containers;
        }
        function applyMobileGameZoom() {
            const activeGame = getActiveGameContainer();
            if (!activeGame) return;

            const viewportPadding = 16;
            const touchControlsHeight = 100;
            const singleBoardWidth = GAME_CANVAS_WIDTH + 14; // 960 canvas + 2*7 border
            const availableWidth = Math.max(300, window.innerWidth - viewportPadding);
            const availableHeight = Math.max(200, window.innerHeight - touchControlsHeight - viewportPadding);
            // AI mode desktop: two boards side-by-side; mobile: stacked
            const isDesktop = window.innerWidth >= 769;
            const targetWidth = document.body.classList.contains('ai-mode') && isDesktop
                ? 2 * singleBoardWidth + 20  // two boards + gap
                : singleBoardWidth;
            const targetHeight = document.body.classList.contains('ai-mode') && !isDesktop
                ? 2 * GAME_CANVAS_HEIGHT + 40  // two stacked boards + gap
                : GAME_CANVAS_HEIGHT;
            const widthScale = availableWidth / targetWidth;
            const heightScale = availableHeight / targetHeight;
            const scale = Math.min(1, widthScale, document.body.classList.contains('ai-mode') && !isDesktop ? heightScale : 1);

            // AI mode: apply scaling (side-by-side on desktop, stacked + fixed/centered on mobile)
            if (document.body.classList.contains('ai-mode')) {
                const visible = getVisibleGameContainers();
                const row = document.querySelector('.ai-boards-row');
                if (isDesktop) {
                    // Desktop: scale each board individually
                    for (const container of visible) {
                        if (scale < 1) {
                            container.style.transform = `scale(${scale})`;
                            container.style.transformOrigin = 'top center';
                            container.style.width = `${100 / scale}%`;
                        } else {
                            container.style.transform = '';
                            container.style.transformOrigin = '';
                            container.style.width = '';
                        }
                    }
                    if (row) {
                        row.style.transform = '';
                        row.style.transformOrigin = '';
                    }
                } else {
                    // Mobile: fix/center the whole stack and scale (zoom out + lock in place)
                    for (const container of visible) {
                        container.style.transform = '';
                        container.style.transformOrigin = '';
                        container.style.width = '';
                    }
                    if (row) {
                        if (scale < 1) {
                            row.style.transform = `translate(-50%, -50%) scale(${scale})`;
                            row.style.transformOrigin = 'center center';
                        } else {
                            row.style.transform = 'translate(-50%, -50%)';
                            row.style.transformOrigin = 'center center';
                        }
                    }
                }
                return;
            }

            // Desktop: keep normal flow under logo, centered horizontally.
            if (scale >= 1) {
                activeGame.style.transform = '';
                activeGame.style.transformOrigin = '';
                activeGame.style.width = '';
                return;
            }

            // Narrow/mobile: keep viewport centering and scale down to fit width.
            activeGame.style.transform = `translate(-50%, -50%) scale(${scale})`;
            activeGame.style.transformOrigin = 'center center';
            activeGame.style.width = '';
        }
        function restoreViewport() {
            const game1 = document.getElementById('game1');
            const game2 = document.getElementById('game2');
            const row = document.querySelector('.ai-boards-row');

            if (game1) {
                game1.style.transform = '';
                game1.style.transformOrigin = '';
                game1.style.width = '';
            }
            if (game2) {
                game2.style.transform = '';
                game2.style.transformOrigin = '';
                game2.style.width = '';
            }
            if (row) {
                row.style.transform = '';
                row.style.transformOrigin = '';
            }
        }

        window.addEventListener('resize', () => {
            if (isGameVisible()) applyMobileGameZoom();
        });

        // Single Player
        document.getElementById('single').onclick = function() {
            document.body.classList.remove('ai-mode');
            window.gameInstanceOptions = {};
            socket.emit('single');
            hideRoomCode();
            document.getElementById('playbuttons').classList.add('hidden');
            
            // Hide all homepage elements except logo and particles
            const titleElement = document.querySelector('.title');
            if (titleElement) titleElement.style.display = 'none';
            
            const menuContainer = document.querySelector('.menu-container');
            if (menuContainer) menuContainer.style.display = 'none';
            
            const scanlines = document.querySelector('.scanlines');
            if (scanlines) scanlines.style.display = 'none';
            // Keep particles visible for starry background during gameplay
            
            if (!window.scriptLoaded || !window.gameInstance2Created) {
                if (window.scriptLoaded) window.scriptLoaded = false;
                const script = document.createElement('script');
                script.src = './scripts/script.js';
                script.type = 'module';
                document.head.appendChild(script);
            }
            
            // Show Player 1 game container (single player uses Player 1)
            document.getElementById('game1').classList.remove('hidden');
            
            // Show touch controls
            document.getElementById('touchControls').classList.remove('hidden');
            
            applyMobileGameZoom();
        };

        // AI Mode (play against server bot)
        document.getElementById('aiMode').onclick = function() {
            const defaultVirusCount = 5;
            const input = prompt('Set starting virus amount for AI match:', String(defaultVirusCount));
            let virusCount = parseInt(input, 10);
            if (isNaN(virusCount) || virusCount <= 0) virusCount = defaultVirusCount;

            showRoomCode('ü§ñ Spinning up AI opponent...');
            socket.emit('startAIMode', { virusCount });
        };

        // Free Play (Multiplayer Lobby)
        document.getElementById('freePlay').onclick = function() {
            document.body.classList.remove('ai-mode');
            window.gameInstanceOptions = {};
            socket.emit('joinLobby');
            showRoomCode('üîç Searching for opponents...');
            this.innerHTML = 'üîç SEARCHING... <div class="loading"></div>';
            this.disabled = true;
        };

        socket.on('assignPlayerNumber', (playerNumber) => {
            player = playerNumber;
        });

        socket.on('startFreePlay', (data) => {
            roomCode = data.roomCode;
            hideRoomCode();
            document.getElementById('playbuttons').classList.add('hidden');
            
            // Hide all homepage elements except logo and particles
            const titleElement = document.querySelector('.title');
            if (titleElement) titleElement.style.display = 'none';
            
            const menuContainer = document.querySelector('.menu-container');
            if (menuContainer) menuContainer.style.display = 'none';
            
            const scanlines = document.querySelector('.scanlines');
            if (scanlines) scanlines.style.display = 'none';
            // Keep particles visible for starry background during gameplay
            
            if (data.player === 1) {
                if (!window.scriptLoaded) {
                    const script = document.createElement('script');
                    script.src = './scripts/script.js';
                    script.type = 'module';
                    document.head.appendChild(script);
                }
                
                // Show Player 1 game container
                document.getElementById('game1').classList.remove('hidden');
                
                // Show touch controls
                document.getElementById('touchControls').classList.remove('hidden');
                applyMobileGameZoom();
            } else if (data.player === 2) {
                if (!window.scriptLoaded) {
                    const script = document.createElement('script');
                    script.src = './scripts/script.js';
                    script.type = 'module';
                    document.head.appendChild(script);
                }
                
                // Show Player 2 game container
                document.getElementById('game2').classList.remove('hidden');
                
                // Show touch controls
                document.getElementById('touchControls').classList.remove('hidden');
                applyMobileGameZoom();
            }
        });

        socket.on('startAIMode', (data) => {
            roomCode = data.roomCode;
            who = 1;
            window.sharedGameData = data.gameData;
            document.body.classList.add('ai-mode');
            window.gameInstanceOptions = {
                2: { isAIOpponentView: true }
            };
            hideRoomCode();
            document.getElementById('playbuttons').classList.add('hidden');

            // Hide all homepage elements except logo and particles
            const titleElement = document.querySelector('.title');
            if (titleElement) titleElement.style.display = 'none';

            const menuContainer = document.querySelector('.menu-container');
            if (menuContainer) menuContainer.style.display = 'none';

            const scanlines = document.querySelector('.scanlines');
            if (scanlines) scanlines.style.display = 'none';

            if (!window.scriptLoaded) {
                const script = document.createElement('script');
                script.src = './scripts/script.js';
                script.type = 'module';
                document.head.appendChild(script);
            }

            document.getElementById('game1').classList.remove('hidden');
            document.getElementById('game2').classList.remove('hidden');
            document.getElementById('touchControls').classList.remove('hidden');
            applyMobileGameZoom();
        });

        // Create Room
        document.getElementById('createRoom').onclick = function() {
            document.body.classList.remove('ai-mode');
            window.gameInstanceOptions = {};
            roomCode = generateRoomCode();

            // Ask for virus amount/level with default autofilled (5)
            const defaultVirusCount = 5;
            let input = prompt('Set virus amount/level:', String(defaultVirusCount));
            let virusCount = parseInt(input, 10);
            if (isNaN(virusCount) || virusCount <= 0) {
                virusCount = defaultVirusCount;
            }

            // Send room creation with settings to server
            socket.emit('createRoom', { roomCode, virusCount });
            who = 1;

            // Copy to clipboard
            navigator.clipboard.writeText(roomCode)
                .then(() => {
                    showRoomCode(`üè† Room Created!\nCode: ${roomCode}`);
                })
                .catch(err => {
                    console.error('Failed to copy room code to clipboard', err);
                    showRoomCode(`üè† Room Created!\nCode: ${roomCode}`);
                });
        };

        socket.on('roomJoined', (roomCode) => {
            hideRoomCode();
            document.getElementById('playbuttons').classList.add('hidden');
            
            // Hide all homepage elements except logo and particles
            const titleElement = document.querySelector('.title');
            if (titleElement) titleElement.style.display = 'none';
            
            const menuContainer = document.querySelector('.menu-container');
            if (menuContainer) menuContainer.style.display = 'none';
            
            const scanlines = document.querySelector('.scanlines');
            if (scanlines) scanlines.style.display = 'none';
            // Keep particles visible for starry background during gameplay
            
            // Show waiting message for first player
            if (who == 1) {
                showRoomCode('‚è≥ Waiting for Player 2 to join...');
            }
        });

        // New event: Game is ready to start with both players
        socket.on('gameReady', (data) => {
            console.log(`üü¢ CLIENT: Received gameReady event with data:`, data);
            console.log(`üü¢ CLIENT: Game data virus positions:`, data.gameData.virusPositions);
            console.log(`üü¢ CLIENT: Game data pill colors (first 10):`, data.gameData.randomList.slice(0, 10));
            
            // Store the shared game data globally for the game to use
            window.sharedGameData = data.gameData;
            
            if (who == 2) {
                if (!window.scriptLoaded) {
                    const script = document.createElement('script');
                    script.src = './scripts/script.js';
                    script.type = 'module';
                    document.head.appendChild(script);
                }
                
                // Show Player 2 game container
                document.getElementById('game2').classList.remove('hidden');
                
                // Show touch controls
                document.getElementById('touchControls').classList.remove('hidden');
                applyMobileGameZoom();
            }

            if (who == 1) {
                if (!window.scriptLoaded) {
                    const script = document.createElement('script');
                    script.src = './scripts/script.js';
                    script.type = 'module';
                    document.head.appendChild(script);
                }
                
                // Show Player 1 game container
                document.getElementById('game1').classList.remove('hidden');
                
                // Show touch controls
                document.getElementById('touchControls').classList.remove('hidden');
                applyMobileGameZoom();
            }
            
            // If game was already created, initialize it with shared data
            if (window.currentGame && window.currentGame.initializeWithSharedData) {
                window.currentGame.initializeWithSharedData();
            }
        });

        socket.on('error', (message) => {
            showRoomCode(`‚ùå Error: ${message}`, true);
        });

        // Join Room
        document.getElementById('joinRoom').onclick = function() {
            document.body.classList.remove('ai-mode');
            window.gameInstanceOptions = {};
            const inputCode = prompt('Enter the 4-letter room code:');
            if (inputCode && inputCode.length === 4) {
                roomCode = inputCode.toUpperCase();
                socket.emit('joinRoom', roomCode);
                who = 2;
                showRoomCode(`üö™ Joining room: ${roomCode}...`);
            } else if (inputCode) {
                showRoomCode('‚ùå Invalid room code! Must be 4 letters.', true);
            }
        };

        // Rules button
        document.getElementById('rulesBtn').onclick = function() {
            document.getElementById('rulesOverlay').classList.remove('hidden');
        };
        document.getElementById('rulesClose').onclick = function() {
            document.getElementById('rulesOverlay').classList.add('hidden');
        };
        document.getElementById('rulesOverlay').addEventListener('click', function(e) {
            if (e.target === this) this.classList.add('hidden');
        });

        function generateRoomCode() {
            let result = '';
            let characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let charactersLength = characters.length;
            for (let i = 0; i < 4; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }

        function toggleAiModeButton() {
            const aiBtn = document.getElementById('aiMode');
            if (aiBtn) {
                aiBtn.classList.toggle('visible');
                aiBtn.setAttribute('aria-hidden', aiBtn.classList.contains('visible') ? 'false' : 'true');
            }
        }
        // Logo click: reveal AI Mode button
        const logoEl = document.getElementById('logoClick');
        if (logoEl) logoEl.addEventListener('click', toggleAiModeButton);
        // Ctrl+Shift / Cmd+Shift: toggle AI Mode button visibility
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.shiftKey) {
                toggleAiModeButton();
                e.preventDefault();
            }
        });

        // Add keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                const focusedButton = document.activeElement;
                if (focusedButton && focusedButton.classList.contains('menu-button')) {
                    focusedButton.click();
                }
            }
        });

        // Add sound effects (optional)
        function playClickSound() {
            // You can add sound effects here if you have audio files
        }

        function returnToHomepage() {
            document.body.classList.remove('ai-mode');
            window.gameInstanceOptions = {};
            const aiBtn = document.getElementById('aiMode');
            if (aiBtn) aiBtn.classList.remove('visible');
            restoreViewport();
            
            // Show all homepage elements again
            const titleElement = document.querySelector('.title');
            if (titleElement) titleElement.style.display = 'block';
            
            const menuContainer = document.querySelector('.menu-container');
            if (menuContainer) menuContainer.style.display = 'flex';
            
            const particles = document.querySelector('.particles');
            if (particles) particles.style.display = 'block';
            
            const scanlines = document.querySelector('.scanlines');
            if (scanlines) scanlines.style.display = 'block';
            
            // Hide game containers
            document.getElementById('game1').classList.add('hidden');
            document.getElementById('game2').classList.add('hidden');
            
            // Hide touch controls
            document.getElementById('touchControls').classList.add('hidden');
            
            // Show play buttons
            document.getElementById('playbuttons').classList.remove('hidden');
            
            // Hide room code if visible
            hideRoomCode();
        }

        function showGameAlert(title, message, isWin = false) {
            // Remove any existing alert
            const existingAlert = document.querySelector('.alert-overlay');
            if (existingAlert) {
                existingAlert.remove();
            }

            // Create alert overlay
            const overlay = document.createElement('div');
            overlay.className = 'alert-overlay';

            // Create alert modal
            const modal = document.createElement('div');
            modal.className = 'alert-modal';

            // Create title
            const titleElement = document.createElement('div');
            titleElement.className = `alert-title ${isWin ? 'win' : 'lose'}`;
            titleElement.textContent = title;

            // Create message
            const messageElement = document.createElement('div');
            messageElement.className = 'alert-message';
            messageElement.textContent = message;

            // Buttons container
            const buttonsWrapper = document.createElement('div');
            buttonsWrapper.style.display = 'flex';
            buttonsWrapper.style.flexDirection = 'column';
            buttonsWrapper.style.alignItems = 'center';
            buttonsWrapper.style.justifyContent = 'center';
            buttonsWrapper.style.gap = '12px';

            // Next Round button (multiplayer only)
            const nextRoundBtn = document.createElement('button');
            nextRoundBtn.className = 'alert-button';
            nextRoundBtn.textContent = 'NEXT ROUND (+1 VIRUS)';
            nextRoundBtn.onclick = () => {
                nextRoundBtn.disabled = true;
                nextRoundBtn.textContent = 'Waiting for opponent‚Ä¶';
                // signal readiness to server
                if (typeof roomCode !== 'undefined' && roomCode) {
                    socket.emit('nextRoundReady', { roomCode });
                }
            };

            // Exit to menu button
            const exitBtn = document.createElement('button');
            exitBtn.className = 'alert-button';
            exitBtn.textContent = 'EXIT';
            exitBtn.onclick = () => {
                overlay.remove();
                returnToHomepage();
            };

            // Assemble buttons
            if (typeof roomCode !== 'undefined' && roomCode) {
                buttonsWrapper.appendChild(nextRoundBtn);
            }
            buttonsWrapper.appendChild(exitBtn);

            // Assemble modal
            modal.appendChild(titleElement);
            modal.appendChild(messageElement);
            modal.appendChild(buttonsWrapper);
            overlay.appendChild(modal);

            // Add to page
            document.body.appendChild(overlay);

            // Focus a button for keyboard navigation
            setTimeout(() => (typeof roomCode !== 'undefined' && roomCode ? nextRoundBtn : exitBtn).focus(), 100);
        }

        // Touch Controls Functionality
        function setupTouchControls() {
            const moveLeft = document.getElementById('moveLeft');
            const moveRight = document.getElementById('moveRight');
            const rotateLeft = document.getElementById('rotateLeft');
            const rotateRight = document.getElementById('rotateRight');
            const dropFast = document.getElementById('dropFast');

            if (moveLeft) {
                moveLeft.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    triggerKeyEvent('KeyA');
                });
                moveLeft.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    triggerKeyEvent('KeyA');
                });
            }

            if (moveRight) {
                moveRight.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    triggerKeyEvent('KeyD');
                });
                moveRight.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    triggerKeyEvent('KeyD');
                });
            }

            if (rotateLeft) {
                rotateLeft.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    triggerKeyEvent('KeyW');
                });
                rotateLeft.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    triggerKeyEvent('KeyW');
                });
            }

            if (rotateRight) {
                rotateRight.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    triggerKeyEvent('Space');
                });
                rotateRight.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    triggerKeyEvent('Space');
                });
            }

            if (dropFast) {
                dropFast.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    triggerKeyEvent('KeyS');
                });
                dropFast.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    triggerKeyEvent('KeyS');
                });
            }
        }

        function triggerKeyEvent(keyCode) {
            // Map key codes to the values the game expects
            const keyMap = {
                'KeyA': 'a',
                'KeyD': 'd', 
                'KeyW': 'w',
                'KeyS': 's',
                'Space': 'Shift'  // Space maps to Shift for right rotation
            };
            
            const gameKey = keyMap[keyCode] || keyCode;
            
            // Create and dispatch keyboard events
            const keydownEvent = new KeyboardEvent('keydown', {
                key: gameKey,
                code: keyCode,
                keyCode: getKeyCode(keyCode),
                which: getKeyCode(keyCode),
                bubbles: true,
                cancelable: true
            });
            
            const keyupEvent = new KeyboardEvent('keyup', {
                key: gameKey,
                code: keyCode,
                keyCode: getKeyCode(keyCode),
                which: getKeyCode(keyCode),
                bubbles: true,
                cancelable: true
            });

            document.dispatchEvent(keydownEvent);
            setTimeout(() => document.dispatchEvent(keyupEvent), 100);
        }

        function getKeyCode(keyCode) {
            const keyMap = {
                'KeyA': 65,
                'KeyD': 68,
                'KeyW': 87,
                'KeyS': 83,
                'Space': 32
            };
            return keyMap[keyCode] || 0;
        }

        // Add click sounds to buttons
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('.menu-button');
            buttons.forEach(button => {
                button.addEventListener('click', playClickSound);
            });
            
            // Setup touch controls
            setupTouchControls();
        });
    </script>
</body>
</html>
